name: QE build (Windows MinGW)

on:
  push:
    branches: [ main ]
    paths:
      - ".github/workflows/qe-windows-mingw.yml"
      - "toolchains/quantum_espresso/windows/**"
      - "toolchains/quantum_espresso/README.md"
  pull_request:
    branches: [ main ]
    paths:
      - ".github/workflows/qe-windows-mingw.yml"
      - "toolchains/quantum_espresso/windows/**"
      - "toolchains/quantum_espresso/README.md"

jobs:
  build-qe-windows-mingw:
    name: "QE 7.5 build (Windows MinGW)"
    runs-on: windows-latest

    defaults:
      run:
        shell: msys2 {0}

    env:
      QE_VERSION: qe-7.5
      QE_TARBALL_URL: https://gitlab.com/QEF/q-e/-/archive/qe-7.5/q-e-qe-7.5.tar.gz

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up MSYS2 (MINGW64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >
            base-devel git wget patch
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-gcc-fortran
            mingw-w64-x86_64-openblas
            mingw-w64-x86_64-fftw
            mingw-w64-x86_64-hdf5
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-omp
            mingw-w64-x86_64-pkg-config

      - name: Prepare QE source tree
        run: |
          set -e

          # Use fixed paths (matching old workflow pattern)
          QE_SRC_DIR="/c/q-e-src"
          QE_PREFIX_UNIX="/c/qe-install"
          QE_PREFIX_WIN="C:\\qe-install"

          echo "QE_SRC_DIR=$QE_SRC_DIR" >> "$GITHUB_ENV"
          echo "QE_PREFIX=$QE_PREFIX_UNIX" >> "$GITHUB_ENV"
          echo "QE_PREFIX_WIN=$QE_PREFIX_WIN" >> "$GITHUB_ENV"
          
          mkdir -p "$QE_SRC_DIR"
          mkdir -p "$QE_PREFIX_UNIX"

          cd /c

          echo "Downloading QE tarball..."
          wget -q "$QE_TARBALL_URL" -O qe.tar.gz

          echo "Unpacking..."
          tar -xzf qe.tar.gz
          rm qe.tar.gz

          EXTRACTED=$(find . -maxdepth 1 -type d -name "q-e-qe-7.5*" | head -1)
          if [ -z "$EXTRACTED" ]; then
            echo "Failed to find extracted QE source directory"
            ls -la
            exit 1
          fi

          rm -rf "$QE_SRC_DIR"
          mv "$EXTRACTED" "$QE_SRC_DIR"

          echo "QE source in $QE_SRC_DIR"
          ls -la "$QE_SRC_DIR" | head -20
          test -f "$QE_SRC_DIR/CMakeLists.txt" || (echo "CMakeLists.txt not found" && exit 1)

      - name: Download and apply MinGW compatibility patches
        run: |
          set -e
          cd "$QE_SRC_DIR"

          # Download all patches from MSYS2 repository
          echo "Downloading patches from MSYS2 repository..."
          PATCH_DIR="/tmp/qe-patches"
          mkdir -p "$PATCH_DIR"
          
          wget -q "https://raw.githubusercontent.com/msys2/MINGW-packages/master/mingw-w64-quantum-espresso/001-use-srand-instead-of-srandom.patch" -O "$PATCH_DIR/001.patch"
          wget -q "https://raw.githubusercontent.com/msys2/MINGW-packages/master/mingw-w64-quantum-espresso/002-fix-build-devxlib-on-mingw.patch" -O "$PATCH_DIR/002.patch"
          wget -q "https://raw.githubusercontent.com/msys2/MINGW-packages/master/mingw-w64-quantum-espresso/003-fix-install-c-libraries.patch" -O "$PATCH_DIR/003.patch"
          wget -q "https://raw.githubusercontent.com/msys2/MINGW-packages/master/mingw-w64-quantum-espresso/004-fix-executable-suffix-on-mingw.patch" -O "$PATCH_DIR/004.patch"

          # Apply patches in order (matching PKGBUILD: apply_patch_with_msg)
          # -N: don't apply if already applied
          # -b: backup original files
          # -p1: strip first directory level from patch paths
          echo "Applying patch 001: use-srand-instead-of-srandom"
          patch -Nbp1 -i "$PATCH_DIR/001.patch" || echo "Patch 001: may already be applied or failed (continuing)"

          echo "Applying patch 002: fix-build-devxlib-on-mingw"
          patch -Nbp1 -i "$PATCH_DIR/002.patch" 2>&1 || echo "Patch 002: may already be applied or failed (will verify and fix if needed)"
          
          # Always verify and apply manual fix if needed (patch might not apply due to path differences)
          echo "Verifying and fixing sys/times.h issue in devxlib..."
          TIMER_FILES=$(find . -path "*/devxlib/src/timer.c" -o -path "*/devxlib/timer.c" 2>/dev/null || true)
          
          if [ -n "$TIMER_FILES" ]; then
            for TIMER_FILE in $TIMER_FILES; do
              if grep -q "#include <sys/times.h>" "$TIMER_FILE" 2>/dev/null && ! grep -q "_WIN32" "$TIMER_FILE" 2>/dev/null; then
                echo "Applying manual fix to $TIMER_FILE (replacing sys/times.h with Windows-compatible implementation)"
                # Use awk to replace sys/times.h include with Windows-compatible version
                # This matches the MSYS2 patch approach: provide struct tms and times() stub for Windows
                awk '{
                  if (/#include <sys\/times.h>/) {
                    print "#if !defined(_WIN32)"
                    print "#include <sys/times.h>"
                    print "#else"
                    print "#include <time.h>"
                    print "/* Minimal struct tms + times() stub for Windows/MinGW."
                    print "   Only used for timing, will not affect numerical correctness. */"
                    print "struct tms {"
                    print "  clock_t tms_utime;"
                    print "  clock_t tms_stime;"
                    print "  clock_t tms_cutime;"
                    print "  clock_t tms_cstime;"
                    print "};"
                    print "static clock_t times(struct tms *buf) {"
                    print "  if (buf) {"
                    print "    buf->tms_utime  = 0;"
                    print "    buf->tms_stime  = 0;"
                    print "    buf->tms_cutime = 0;"
                    print "    buf->tms_cstime = 0;"
                    print "  }"
                    print "  return (clock_t)clock();"
                    print "}"
                    print "#endif"
                  } else {
                    print
                  }
                }' "$TIMER_FILE" > "$TIMER_FILE.tmp" && mv "$TIMER_FILE.tmp" "$TIMER_FILE"
                echo "Fixed $TIMER_FILE"
              else
                echo "$TIMER_FILE already has Windows guard or doesn't need fixing"
              fi
            done
          else
            echo "No timer.c files found in devxlib (may not be needed for this build)"
          fi

          echo "Applying patch 003: fix-install-c-libraries"
          patch -Nbp1 -i "$PATCH_DIR/003.patch" || echo "Patch 003: may already be applied or failed (continuing)"

          echo "Applying patch 004: fix-executable-suffix-on-mingw"
          patch -Nbp1 -i "$PATCH_DIR/004.patch" || echo "Patch 004: may already be applied or failed (continuing)"

          echo "All patches processed"

      - name: Configure QE with CMake (MinGW + OpenBLAS + FFTW)
        run: |
          set -e
          cd "$QE_SRC_DIR"

          # Prevent MSYS2 from converting CMAKE_INSTALL_PREFIX path
          export MSYS2_ARG_CONV_EXCL="-DCMAKE_INSTALL_PREFIX="

          # Set FFLAGS to suppress warnings (as in PKGBUILD)
          export FFLAGS=" -Wno-missing-include-dirs -w"
          export CFLAGS=" -Wno-incompatible-pointer-types"

          mkdir -p build

          "${MINGW_PREFIX}/bin/cmake.exe" -Wno-dev \
            -GNinja \
            -DCMAKE_INSTALL_PREFIX="$QE_PREFIX" \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DQE_ENABLE_FOX=OFF \
            -DQE_ENABLE_HDF5=OFF \
            -DQE_ENABLE_OPENMP=ON \
            -DQE_ENABLE_ENVIRON=OFF \
            -DQE_ENABLE_LIBXC=OFF \
            -DQE_ENABLE_MPI=OFF \
            -DQE_ENABLE_TEST=OFF \
            -DQE_ENABLE_PLUGINS="" \
            -DQE_DEVICEXLIB_INTERNAL=ON \
            -DQE_FOX_INTERNAL=OFF \
            -DQE_MBD_INTERNAL=ON \
            -DQE_WANNIER90_INTERNAL=ON \
            -DQE_FFTW_VENDOR="FFTW3" \
            -DBLA_VENDOR=OpenBLAS \
            -S "$QE_SRC_DIR" \
            -B build

          echo "CMake configuration finished"
          echo "CMake cache (first 50 lines):"
          head -50 build/CMakeCache.txt || true

      - name: Build QE with CMake (pw.x)
        run: |
          set -e
          cd "$QE_SRC_DIR"

          "${MINGW_PREFIX}/bin/cmake.exe" --build build --target pw

          echo "Build completed"
          echo "Looking for pw executable (patch 004 removes .x suffix on Windows)..."
          find build -type f \( -name "pw" -o -name "pw.exe" -o -name "pw.x" -o -name "pw.x.exe" \) | head -10

      - name: Package Windows artifacts
        run: |
          set -e
          cd "$QE_SRC_DIR"

          mkdir -p "$QE_PREFIX/bin"

          # Find pw executable (patch 004 removes .x suffix, so it may be "pw" or "pw.exe")
          PW_EXE=$(find build -type f \( -name "pw" -o -name "pw.exe" -o -name "pw.x" -o -name "pw.x.exe" \) | head -1)

          if [ -z "$PW_EXE" ]; then
            echo "ERROR: pw executable not found"
            echo "Searching build directory:"
            find build -type f -name "*pw*" | head -20
            exit 1
          fi

          echo "Found pw executable: $PW_EXE"
          # Copy to bin with .exe extension for Windows
          cp "$PW_EXE" "$QE_PREFIX/bin/pw.x.exe"

          # Copy required DLLs from MinGW
          echo "Copying required DLLs..."
          cp /mingw64/bin/libopenblas*.dll "$QE_PREFIX/bin/" 2>/dev/null || true
          cp /mingw64/bin/libgfortran-*.dll "$QE_PREFIX/bin/" 2>/dev/null || true
          cp /mingw64/bin/libquadmath-*.dll "$QE_PREFIX/bin/" 2>/dev/null || true
          cp /mingw64/bin/libgcc_s_seh-1.dll "$QE_PREFIX/bin/" 2>/dev/null || true
          cp /mingw64/bin/libwinpthread-1.dll "$QE_PREFIX/bin/" 2>/dev/null || true
          cp /mingw64/bin/libomp*.dll "$QE_PREFIX/bin/" 2>/dev/null || true
          cp /mingw64/bin/libfftw3*.dll "$QE_PREFIX/bin/" 2>/dev/null || true

          echo "Final package contents:"
          find "$QE_PREFIX" -type f | sort

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: qe-${{ env.QE_VERSION }}-windows-mingw
          path: ${{ env.QE_PREFIX_WIN }}
