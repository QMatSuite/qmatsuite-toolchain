name: QE build (Windows, Intel + .obj→.o wrapper)

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/qe-windows-intel.yml'
      - 'toolchains/quantum_espresso/windows/**'
      - 'toolchains/quantum_espresso/README.md'
  pull_request:
    branches: [ main ]
    paths:
      - '.github/workflows/qe-windows-intel.yml'
      - 'toolchains/quantum_espresso/windows/**'
      - 'toolchains/quantum_espresso/README.md'

jobs:
  build-qe-windows-intel:
    name: QE 7.5 build (windows-latest, Intel classic)
    runs-on: windows-latest

    env:
      QE_VERSION: "qe-7.5"
      QE_TARBALL_URL: "https://gitlab.com/QEF/q-e/-/archive/qe-7.5/q-e-qe-7.5.tar.gz"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QE paths
        shell: bash
        run: |
          echo "QE_SRC_DIR=/c/q-e-src" >> "$GITHUB_ENV"
          echo "QE_PREFIX=/c/qe-install" >> "$GITHUB_ENV"

      - name: Setup Intel Fortran (classic)
        uses: fortran-lang/setup-fortran@v1
        with:
          compiler: intel-classic
          version: '2021.10'
          update-environment: true
          cache: true

      - name: Show compilers
        shell: bash
        run: |
          echo "FC=$FC"
          echo "CC=$CC"
          echo "CXX=$CXX"
          command -v ifort  || echo "ifort not in PATH"
          command -v icl    || echo "icl not in PATH"
          command -v ar     || echo "ar not in PATH (needed by wrapper)"

      - name: Download and unpack QE
        shell: bash
        env:
          QE_SRC_DIR: ${{ env.QE_SRC_DIR }}
          QE_TARBALL_URL: ${{ env.QE_TARBALL_URL }}
        run: |
          echo "Using QE_SRC_DIR=$QE_SRC_DIR"
          mkdir -p "$(dirname "$QE_SRC_DIR")"
          cd "$(dirname "$QE_SRC_DIR")"

          curl -L "$QE_TARBALL_URL" -o qe.tar.gz
          tar -xzf qe.tar.gz
          rm qe.tar.gz

          EXTRACTED=$(find . -maxdepth 1 -type d -name "q-e-qe-7.5*" | head -1)
          if [ -z "$EXTRACTED" ]; then
            echo "Failed to find extracted QE source directory"
            ls -la
            exit 1
          fi

          rm -rf "$QE_SRC_DIR"
          mv "$EXTRACTED" "$QE_SRC_DIR"

          echo "QE source extracted to: $QE_SRC_DIR"
          ls -la "$QE_SRC_DIR" | head -40
          test -f "$QE_SRC_DIR/configure" || (echo "configure script not found!" && exit 1)

      - name: Prepare AR wrapper (.obj → .o)
        shell: bash
        env:
          QE_SRC_DIR: ${{ env.QE_SRC_DIR }}
        run: |
          cd "$QE_SRC_DIR"
          cat > ar-wrapper.sh << 'EOF'
          #!/usr/bin/env bash
          set -e
          shopt -s nullglob

          # Rename all .obj to .o in current directory, if .o does not exist yet
          for obj in *.obj; do
            [ -e "$obj" ] || continue
            base="${obj%.obj}"
            if [ ! -f "$base.o" ]; then
              mv "$obj" "$base.o"
            fi
          done

          # Call the real ar
          ar "$@"
          EOF

          chmod +x ar-wrapper.sh
          echo "Created AR wrapper:"
          sed -n '1,40p' ar-wrapper.sh

      - name: Configure QE (serial, Intel compilers)
        shell: bash
        env:
          QE_SRC_DIR: ${{ env.QE_SRC_DIR }}
        run: |
          cd "$QE_SRC_DIR"

          # Use AR wrapper and internal BLAS/LAPACK/FFTW
          AR="$PWD/ar-wrapper.sh" \
          ./install/configure \
            F90=ifort \
            MPIF90=ifort \
            CC=icl

          echo "---- make.inc (top) ----"
          sed -n '1,80p' make.inc || true

      - name: Patch Fortran flags & UtilXlib deps
        shell: bash
        env:
          QE_SRC_DIR: ${{ env.QE_SRC_DIR }}
        run: |
          cd "$QE_SRC_DIR"

          echo "Patching make.inc to remove -g from Fortran flags..."
          if [ -f make.inc ]; then
            sed -i 's/ -g//g' make.inc || true
          fi

          echo "Patching install/make_lapack.inc to remove -g (for external LAPACK)..."
          if [ -f install/make_lapack.inc ]; then
            sed -i 's/ -g//g' install/make_lapack.inc || true
          fi

          echo "Ensuring UtilXlib/make.depend exists..."
          mkdir -p UtilXlib
          touch UtilXlib/make.depend
          ls -la UtilXlib

      - name: Skip devxlib (libcuda)
        shell: bash
        env:
          QE_SRC_DIR: ${{ env.QE_SRC_DIR }}
        run: |
          cd "$QE_SRC_DIR"
          mkdir -p install
          touch install/libcuda_devxlib
          echo "Created install/libcuda_devxlib to skip devxlib build"

      - name: Build QE (pw.x only)
        shell: bash
        env:
          QE_SRC_DIR: ${{ env.QE_SRC_DIR }}
        run: |
          cd "$QE_SRC_DIR"

          # Not too many jobs to avoid weird races on Windows
          make pw -j2

          echo "Listing PW/src after build:"
          ls -la PW/src

      - name: Package pw.x.exe
        shell: bash
        env:
          QE_SRC_DIR: ${{ env.QE_SRC_DIR }}
          QE_PREFIX: ${{ env.QE_PREFIX }}
        run: |
          cd "$QE_SRC_DIR"

          if [ -f PW/src/pw.x.exe ]; then
            BIN="PW/src/pw.x.exe"
          elif [ -f PW/src/pw.x ]; then
            BIN="PW/src/pw.x"
          else
            echo "pw.x[.exe] not found after build"
            ls -la PW/src
            exit 1
          fi

          mkdir -p "$QE_PREFIX/bin"
          cp "$BIN" "$QE_PREFIX/bin/pw.x.exe"

          echo "Installed files under $QE_PREFIX:"
          ls -R "$QE_PREFIX" || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: qe-${{ env.QE_VERSION }}-windows-intel
          path: C:\qe-install
