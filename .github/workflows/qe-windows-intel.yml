name: QE build (Windows, Intel oneAPI via setup-fortran)

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/qe-windows-intel.yml'
      - 'toolchains/quantum_espresso/windows/**'
      - 'toolchains/quantum_espresso/README.md'
  pull_request:
    branches: [ main ]
    paths:
      - '.github/workflows/qe-windows-intel.yml'
      - 'toolchains/quantum_espresso/windows/**'
      - 'toolchains/quantum_espresso/README.md'

jobs:
  build-qe-windows-intel:
    name: QE 7.5 build (windows-latest, Intel classic)
    runs-on: windows-latest

    env:
      QE_VERSION: "qe-7.5"
      QE_TARBALL_URL: "https://gitlab.com/QEF/q-e/-/archive/qe-7.5/q-e-qe-7.5.tar.gz"
      # Unix-style paths for bash steps
      QE_SRC_DIR_UNIX: "/c/q-e-src/q-e-qe-7.5"
      QE_PREFIX_UNIX: "/c/qe-install"
      # Windows-style path for upload-artifact
      QE_PREFIX: "C:\\qe-install"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Install Intel classic Fortran compiler (ifort) via setup-fortran.
      # This will download an offline oneAPI installer (~1.5 GB) on the first run.
      - name: Setup Intel Fortran (classic) via setup-fortran
        uses: fortran-lang/setup-fortran@v1
        with:
          compiler: intel-classic
          version: '2021.10'

      # We intentionally skip MS-MPI here.
      # Goal: get a working serial/OpenMP pw.x build first.

      - name: Download and unpack QE
        shell: bash
        run: |
          set -e
          SRC_DIR="$QE_SRC_DIR_UNIX"

          echo "QE_SRC_DIR_UNIX = $SRC_DIR"

          # Ensure parent directory exists
          mkdir -p /c/q-e-src
          cd /c

          echo "Downloading QE tarball..."
          curl -L "$QE_TARBALL_URL" -o qe.tar.gz

          echo "Unpacking QE tarball..."
          tar -xzf qe.tar.gz
          rm qe.tar.gz

          echo "Looking for extracted QE directory..."
          EXTRACTED=$(find . -maxdepth 1 -type d -name "q-e-qe-7.5*" | head -1)
          echo "EXTRACTED = $EXTRACTED"

          if [ -z "$EXTRACTED" ]; then
            echo "Failed to find extracted QE source directory"
            find . -maxdepth 2 -type d
            exit 1
          fi

          # Move into our fixed SRC_DIR (/c/q-e-src/q-e-qe-7.5)
          mv "$EXTRACTED" "$SRC_DIR"

          echo "Contents of $SRC_DIR:"
          ls -la "$SRC_DIR"

      - name: Show compiler info
        shell: bash
        run: |
          echo "FC=$FC"
          which "$FC" || true
          "$FC" -V || "$FC" --version || true

      - name: Configure QE with Intel classic (use -fpp, no -g)
        shell: bash
        run: |
          set -e
          SRC_DIR="$QE_SRC_DIR_UNIX"
          cd "$SRC_DIR"

          echo "Current directory:"
          pwd
          echo "Top-level contents:"
          ls -la

          if [ ! -f ./configure ]; then
            echo "ERROR: configure script not found in $SRC_DIR"
            exit 1
          fi

          # IMPORTANT:
          # - Use -fpp instead of -cpp so ifort actually runs the preprocessor.
          # - Drop -g because on Windows it turns into ambiguous '/g'.
          # - Apply -fpp to both FFLAGS and F90FLAGS so .f/.f90 all see #if/#endif.
          ./configure \
            F90="$FC" \
            MPIF90="$FC" \
            FFLAGS="-O3 -fpp" \
            F90FLAGS="-O3 -fpp" \
            FFLAGS_NOOPT="-O0 -fpp"

      - name: Build QE (pw.x only)
        shell: bash
        run: |
          set -e
          SRC_DIR="$QE_SRC_DIR_UNIX"
          cd "$SRC_DIR"
          make pw -j2
          ls -la PW/src/pw.x || (echo "pw.x not built" && exit 1)

      - name: Package build artifacts
        shell: bash
        run: |
          set -e
          PREFIX_DIR="$QE_PREFIX_UNIX"
          SRC_DIR="$QE_SRC_DIR_UNIX"

          mkdir -p "$PREFIX_DIR/bin"
          cp "$SRC_DIR/PW/src/pw.x" "$PREFIX_DIR/bin/"

          echo "QE installation tree under $PREFIX_DIR:"
          ls -R "$PREFIX_DIR"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: qe-${{ env.QE_VERSION }}-windows-intel-classic
          path: ${{ env.QE_PREFIX }}
