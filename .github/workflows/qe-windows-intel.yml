name: QE build (Windows, Intel oneAPI via setup-fortran)

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/qe-windows-intel.yml'
      - 'toolchains/quantum_espresso/windows/**'
      - 'toolchains/quantum_espresso/README.md'
  pull_request:
    branches: [ main ]
    paths:
      - '.github/workflows/qe-windows-intel.yml'
      - 'toolchains/quantum_espresso/windows/**'
      - 'toolchains/quantum_espresso/README.md'

jobs:
  build-qe-windows-intel:
    name: QE 7.5 build (windows-latest, Intel classic)
    runs-on: windows-latest

    env:
      QE_VERSION: "qe-7.5"
      QE_TARBALL_URL: "https://gitlab.com/QEF/q-e/-/archive/qe-7.5/q-e-qe-7.5.tar.gz"
      # Unix-style paths for bash steps
      QE_SRC_DIR_UNIX: "/c/q-e-src/q-e-qe-7.5"
      QE_PREFIX_UNIX: "/c/qe-install"
      # Windows-style path for upload-artifact
      QE_PREFIX: "C:\\qe-install"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Install Intel classic Fortran compiler (ifort) via setup-fortran.
      # This will download an offline oneAPI installer (~1.5 GB) on the first run.
      - name: Setup Intel Fortran (classic) via setup-fortran
        uses: fortran-lang/setup-fortran@v1
        with:
          compiler: intel-classic
          version: '2021.10'
          cache: true

      # We intentionally skip MS-MPI here.
      # Goal: get a working serial/OpenMP pw.x build first.

      - name: Download and unpack QE
        shell: bash
        run: |
          set -e
          SRC_DIR="$QE_SRC_DIR_UNIX"
          PARENT_DIR=$(dirname "$SRC_DIR")

          echo "QE_SRC_DIR_UNIX = $SRC_DIR"
          echo "PARE
