name: QE build (Windows, Intel oneAPI)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-qe-windows-intel:
    name: QE 7.5 build (windows-latest, Intel oneAPI + MKL)
    runs-on: windows-latest

    env:
      QE_VERSION: "qe-7.5"
      QE_TARBALL_URL: "https://gitlab.com/QEF/q-e/-/archive/qe-7.5/q-e-qe-7.5.tar.gz"
      QE_SRC_DIR: "C:/q-e-src"
      QE_PREFIX: "C:/qe-install"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Install Intel oneAPI Fortran compiler + MKL.
      # This action installs the HPC toolkit and runs setvars for you.
      - name: Setup Intel Fortran (oneAPI HPC)
        uses: modflowpy/install-intelfortran-action@v1
        with:
          setvars: true
          cache: false

      # Install MS-MPI runtime + SDK (for future MPI builds / packaging).
      - name: Install MS-MPI (runtime + SDK)
        run: |
          choco install -y msmpi msmpisdk
        shell: powershell

      - name: Download and unpack QE
        shell: bash
        run: |
          set -e
          mkdir -p /c/q-e-src
          cd /c
          curl -L "$QE_TARBALL_URL" -o qe.tar.gz
          tar -xzf qe.tar.gz
          rm qe.tar.gz
          EXTRACTED=$(find . -maxdepth 1 -type d -name "q-e-qe-7.5*" | head -1)
          if [ -z "$EXTRACTED" ]; then
            echo "Failed to find extracted QE source directory"
            exit 1
          fi
          mv "$EXTRACTED" "$(echo "$QE_SRC_DIR" | sed 's#C:#/c#')"

      - name: Configure QE with Intel ifort + MKL
        shell: bash
        run: |
          set -e
          SRC_DIR="$(echo "$QE_SRC_DIR" | sed 's#C:#/c#')"
          cd "$SRC_DIR"

          echo "Using Intel Fortran compiler: $FC (expected ifort)"
          echo "MKLROOT=${MKLROOT:-undefined}"

          # Basic configure using ifort. Let configure detect MKL via MKLROOT.
          ./configure \
            F90="${FC:-ifort}" \
            MPIF90="${FC:-ifort}"

      - name: Build QE (pw.x only)
        shell: bash
        run: |
          set -e
          SRC_DIR="$(echo "$QE_SRC_DIR" | sed 's#C:#/c#')"
          cd "$SRC_DIR"
          make pw -j2
          ls -la PW/src/pw.x || (echo "pw.x not built" && exit 1)

      - name: Package build artifacts
        shell: bash
        run: |
          set -e
          PREFIX_DIR="$(echo "$QE_PREFIX" | sed 's#C:#/c#')"
          SRC_DIR="$(echo "$QE_SRC_DIR" | sed 's#C:#/c#')"

          mkdir -p "$PREFIX_DIR/bin"
          cp "$SRC_DIR/PW/src/pw.x" "$PREFIX_DIR/bin/"

          echo "QE installation tree:"
          ls -R "$PREFIX_DIR"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: qe-${{ env.QE_VERSION }}-windows-intel
          path: ${{ env.QE_PREFIX }}

