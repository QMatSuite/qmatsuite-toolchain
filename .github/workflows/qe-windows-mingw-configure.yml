name: QE build (Windows, MinGW-w64)

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/qe-windows-mingw-configure.yml'
      - 'toolchains/quantum_espresso/windows/**'
      - 'toolchains/quantum_espresso/README.md'
  pull_request:
    branches: [ main ]
    paths:
      - '.github/workflows/qe-windows-mingw-configure.yml'
      - 'toolchains/quantum_espresso/windows/**'
      - 'toolchains/quantum_espresso/README.md'

jobs:
  build-qe-windows-mingw:
    name: QE 7.5 build (Windows, MinGW-w64)
    runs-on: windows-latest

    env:
      QE_VERSION: "7.5"
      QE_TARBALL_URL: "https://gitlab.com/QEF/q-e/-/archive/qe-7.5/q-e-qe-7.5.tar.gz"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up MSYS2 (MINGW64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >
            git
            make
            patch
            wget
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-gcc-fortran
            mingw-w64-x86_64-openblas
            mingw-w64-x86_64-fftw

      - name: Define build directories
        shell: msys2 {0}
        run: |
          # GitHub 这台机上的临时目录，MSYS2 里是 /d/a/_temp 之类的路径
          echo "RUNNER_TEMP_MSYS=$RUNNER_TEMP"    # debug
          echo "QE_SRC_DIR=$RUNNER_TEMP/q-e-src"   >> $GITHUB_ENV
          echo "QE_PREFIX_MSYS=$RUNNER_TEMP/qe-install" >> $GITHUB_ENV

          # Windows 侧的安装路径，用来上传 artifact
          # 注意反斜杠要转义
          echo "QE_PREFIX_WIN=${RUNNER_TEMP}\\qe-install" >> $GITHUB_ENV

      - name: Download and unpack QE
        shell: msys2 {0}
        run: |
          mkdir -p "$QE_SRC_DIR"
          cd "$RUNNER_TEMP"

          echo "Downloading QE from: $QE_TARBALL_URL"
          wget -q "$QE_TARBALL_URL" -O qe.tar.gz

          tar -xzf qe.tar.gz
          rm qe.tar.gz

          EXTRACTED=$(find . -maxdepth 1 -type d -name "q-e-qe-7.5*" | head -1)
          if [ -z "$EXTRACTED" ]; then
            echo "Failed to find extracted QE source directory"
            exit 1
          fi

          rm -rf "$QE_SRC_DIR"
          mv "$EXTRACTED" "$QE_SRC_DIR"

          echo "QE source extracted to: $QE_SRC_DIR"
          ls -la "$QE_SRC_DIR" | head -25

          test -f "$QE_SRC_DIR/configure" || (echo "configure script not found!" && exit 1)

      - name: Apply MSYS2 QE MinGW patches
        shell: msys2 {0}
        run: |
          cd "$QE_SRC_DIR"

          # Verify devxlib exists (for patch 002)
          echo "Checking external/devxlib structure:"
          if [ -d "external/devxlib" ]; then
            echo "Found external/devxlib directory"
            ls -la external/devxlib/ 2>/dev/null || true
            if [ -d "external/devxlib/src" ]; then
              echo "Found external/devxlib/src directory"
              ls -la external/devxlib/src/ 2>/dev/null || true
              if [ -f "external/devxlib/src/timer.c" ]; then
                echo "Found external/devxlib/src/timer.c"
              else
                echo "WARNING: external/devxlib/src/timer.c not found"
              fi
            fi
          else
            echo "Warning: external/devxlib not found"
            ls -la external/ 2>/dev/null || true
          fi

          base_url="https://raw.githubusercontent.com/msys2/MINGW-packages/master/mingw-w64-quantum-espresso"

          for p in \
            001-use-srand-instead-of-srandom.patch \
            002-fix-build-devxlib-on-mingw.patch \
            003-fix-install-c-libraries.patch \
            004-fix-executable-suffix-on-mingw.patch
          do
            echo "=========================================="
            echo "Fetching and applying $p"
            echo "=========================================="
            curl -L "$base_url/$p" -o "$p"
            
            # For patch 002, verify target file exists before applying
            if [ "$p" = "002-fix-build-devxlib-on-mingw.patch" ]; then
              if [ ! -f "external/devxlib/src/timer.c" ]; then
                echo "ERROR: external/devxlib/src/timer.c not found - cannot apply patch 002"
                echo "Directory structure:"
                find external/devxlib -type f -name "*.c" 2>/dev/null | head -10 || true
                exit 1
              fi
            fi
            
            echo "Applying $p with: patch --batch -Nbp1"
            # Use --batch to avoid interactive prompts, -N = don't apply if already applied, -b = backup, -p1 = strip first dir
            if patch --batch -Nbp1 < "$p"; then
              echo "✓ Patch $p applied successfully"
            else
              PATCH_EXIT=$?
              echo "Patch $p exit code: $PATCH_EXIT"
              # Check if already applied by trying again and checking output
              PATCH_CHECK=$(patch --batch -Nbp1 < "$p" 2>&1) || true
              if echo "$PATCH_CHECK" | grep -q "already applied\|Skipping patch"; then
                echo "✓ Patch $p already applied (skipping)"
              else
                echo "✗ Patch $p failed"
                echo "Patch check output:"
                echo "$PATCH_CHECK"
                # For patch 002, this is a hard error since we verified the file exists
                if [ "$p" = "002-fix-build-devxlib-on-mingw.patch" ]; then
                  echo "ERROR: Patch 002 failed but timer.c exists - this should not happen"
                  exit 1
                fi
                # For other patches, allow failure (they might be optional)
                echo "Continuing despite patch failure..."
              fi
            fi
          done
          echo "=========================================="
          echo "All patches processed"
          echo "=========================================="

      - name: Configure QE (MinGW + OpenBLAS, via ./configure)
        shell: msys2 {0}
        run: |
          cd "$QE_SRC_DIR"

          # 编译器：MinGW-w64 GCC + GFortran
          export CC=gcc
          export CXX=g++
          export FC=gfortran
          export F90=gfortran
          export MPIF90=gfortran
          export AR=ar
          export RANLIB=ranlib

          # 参考 MSYS2 PKGBUILD 的 flags，关键是关掉 incompatible-pointer-types
          export CFLAGS="-O2 -pipe -Wno-incompatible-pointer-types"
          export FFLAGS="-O2 -pipe -fallow-argument-mismatch"

          echo "Using CC=$CC"
          echo "Using FC=$FC"
          echo "QE_SRC_DIR=$QE_SRC_DIR"

          ./configure \
            F90="$F90" \
            MPIF90="$MPIF90" \
            CC="$CC" \
            CFLAGS="$CFLAGS" \
            FFLAGS="$FFLAGS" \
            AR="$AR" \
            RANLIB="$RANLIB" \
            BLAS_LIBS="-lopenblas" \
            LAPACK_LIBS="-lopenblas"

          echo "=== configure summary ==="
          cat make.inc

      - name: Build QE (pw.x only)
        shell: msys2 {0}
        run: |
          cd "$QE_SRC_DIR"

          # 让顶层 Make 自己处理 UtilXlib / external lapack 等依赖
          make pw -j2

          echo "Built binaries in PW/src:"
          ls -la PW/src

          if [ ! -f PW/src/pw.x ] && [ ! -f PW/src/pw.x.exe ]; then
            echo "pw.x not found after build"
            exit 1
          fi

      - name: Package build artifacts
        shell: msys2 {0}
        run: |
          mkdir -p "$QE_PREFIX_MSYS/bin"

          cd "$QE_SRC_DIR"

          # 兼容可能存在的 pw.x 或 pw.x.exe
          if [ -f PW/src/pw.x.exe ]; then
            cp PW/src/pw.x.exe "$QE_PREFIX_MSYS/bin/"
          elif [ -f PW/src/pw.x ]; then
            cp PW/src/pw.x "$QE_PREFIX_MSYS/bin/"
          fi

          # 打包必要的 DLL（OpenBLAS / Fortran runtime 等）
          cp /mingw64/bin/libopenblas*.dll "$QE_PREFIX_MSYS/bin/" 2>/dev/null || true
          cp /mingw64/bin/libgfortran-*.dll "$QE_PREFIX_MSYS/bin/" 2>/dev/null || true
          cp /mingw64/bin/libquadmath-*.dll "$QE_PREFIX_MSYS/bin/" 2>/dev/null || true
          cp /mingw64/bin/libgcc_s_seh-1.dll "$QE_PREFIX_MSYS/bin/" 2>/dev/null || true
          cp /mingw64/bin/libwinpthread-1.dll "$QE_PREFIX_MSYS/bin/" 2>/dev/null || true

          echo "Installed files under $QE_PREFIX_MSYS:"
          find "$QE_PREFIX_MSYS" -type f | sort

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: qe-${{ env.QE_VERSION }}-windows-mingw
          path: ${{ env.QE_PREFIX_WIN }}

