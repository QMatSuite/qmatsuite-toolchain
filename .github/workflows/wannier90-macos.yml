name: Wannier90 build (macOS)

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/wannier90-macos.yml'
      - 'toolchains/wannier90/README.md'
      - 'toolchains/wannier90/macos/**'
  pull_request:
    branches: [ main ]
    paths:
      - '.github/workflows/wannier90-macos.yml'
      - 'toolchains/wannier90/README.md'
      - 'toolchains/wannier90/macos/**'

jobs:
  build-wannier90:
    name: Wannier90 3.1.0 build (macos-14)
    runs-on: macos-14

    env:
      W90_VERSION: "3.1.0"
      W90_URL: "https://github.com/wannier-developers/wannier90/archive/refs/tags/v3.1.0.tar.gz"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up build directories
        run: |
          echo "W90_PREFIX=$RUNNER_TEMP/wannier90-install" >> $GITHUB_ENV

      - name: Install dependencies (macOS)
        run: |
          brew update
          brew install make wget curl

      - name: Setup Fortran compiler
        uses: fortran-lang/setup-fortran@v1
        with:
          compiler: gcc
          version: latest

      - name: Show compiler info
        run: |
          echo "FC=$FC"
          echo "CC=$CC"
          ${FC:-gfortran} --version || true
          which ${FC:-gfortran} || true

      - name: Build Wannier90
        run: |
          bash toolchains/wannier90/macos/build.sh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wannier90-${{ env.W90_VERSION }}-macos-14
          path: ${{ env.W90_PREFIX }}

