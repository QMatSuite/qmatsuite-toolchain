name: QE Windows oneAPI

on:
  push:
    paths:
      - 'toolchains/quantum_espresso/windows/oneapi/**'
      - '.github/workflows/windows-oneapi-qe.yml'
  pull_request:
    paths:
      - 'toolchains/quantum_espresso/windows/oneapi/**'
      - '.github/workflows/windows-oneapi-qe.yml'
  workflow_dispatch:

concurrency:
  group: windows-oneapi-qe-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: pwsh

jobs:
  build:
    runs-on: windows-latest
    env:
      ONEAPI_ROOT: 'C:\Program Files (x86)\Intel\oneAPI'
      QE_ROOT: '${{ github.workspace }}\toolchains\quantum_espresso\windows\oneapi'
      QE_SRC: '${{ github.workspace }}\toolchains\quantum_espresso\windows\oneapi\upstream\qe'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache QE source/build
        uses: actions/cache@v4
        with:
          path: |
            toolchains/quantum_espresso/windows/oneapi/upstream/qe
          key: qe-oneapi-${{ runner.os }}-${{ hashFiles('toolchains/quantum_espresso/windows/oneapi/patches/**', 'toolchains/quantum_espresso/windows/oneapi/scripts/**') }}
          restore-keys: |
            qe-oneapi-${{ runner.os }}-

      - name: Install oneAPI (Intel compiler + MKL)
        uses: modflowpy/install-intelfortran-action@v1

      - name: Set MKL environment for CMake
        run: |
          if ($env:MKLROOT -and (Test-Path $env:MKLROOT)) {
            $mklRoot = $env:MKLROOT
          } else {
            $mklRoot = Join-Path "$env:ONEAPI_ROOT" "mkl\latest"
          }

          if (-not (Test-Path $mklRoot)) {
            Write-Error "MKL not found. Expected at $mklRoot. Ensure oneAPI MKL is installed."
            exit 1
          }

          $env:MKLROOT = $mklRoot
          $prefix = Join-Path $mklRoot "lib\cmake\mkl"
          $env:CMAKE_PREFIX_PATH = "$prefix;$env:CMAKE_PREFIX_PATH"

          "MKLROOT=$mklRoot" | Out-File -FilePath $env:GITHUB_ENV -Append
          "CMAKE_PREFIX_PATH=$($env:CMAKE_PREFIX_PATH)" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Install build tools (cmake, ninja)
        run: |
          choco install --no-progress -y cmake ninja

      - name: Verify oneAPI
        run: |
          if (-not (Test-Path "$env:ONEAPI_ROOT\setvars.bat")) {
            Write-Error "setvars.bat not found at $env:ONEAPI_ROOT\setvars.bat"
          }

      - name: Refresh QE source (no patch)
        run: |
          pwsh -NoProfile -ExecutionPolicy Bypass `
            -File "$env:QE_ROOT\scripts\refresh_qe_source.ps1" -NoPatch

      - name: Apply QE patches
        run: |
          pwsh -NoProfile -ExecutionPolicy Bypass `
            -File "$env:QE_ROOT\scripts\apply_qe_patches.ps1" `
            -QeDir "$env:QE_SRC" `
            -PatchDir "$env:QE_ROOT\patches"

      - name: Build QE (oneAPI, no MPI)
        run: |
          pwsh -NoProfile -ExecutionPolicy Bypass `
            -File "$env:QE_ROOT\scripts\build_qe_win_oneapi.ps1" -NoMpi

