name: QE build (Linux & macOS)

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/qe-linux-macos.yml'
      - 'toolchains/quantum_espresso/linux/**'
      - 'toolchains/quantum_espresso/macos/**'
      - 'toolchains/quantum_espresso/README.md'
  pull_request:
    branches: [ main ]
    paths:
      - '.github/workflows/qe-linux-macos.yml'
      - 'toolchains/quantum_espresso/linux/**'
      - 'toolchains/quantum_espresso/macos/**'
      - 'toolchains/quantum_espresso/README.md'

jobs:
  build-qe:
    name: QE 7.5 build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, macos-14 ]

    env:
      QE_VERSION: "qe-7.5"
      QE_TARBALL_URL: "https://gitlab.com/QEF/q-e/-/archive/qe-7.5/q-e-qe-7.5.tar.gz"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up build directories
        run: |
          echo "QE_SRC_DIR=$RUNNER_TEMP/q-e-src" >> $GITHUB_ENV
          echo "QE_PREFIX=$RUNNER_TEMP/qe-install" >> $GITHUB_ENV

      # ---------- Linux ----------

      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential \
            gfortran \
            libopenblas-dev \
            liblapack-dev \
            libfftw3-dev \
            wget \
            make

      # ---------- macOS ----------

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-14'
        run: |
          brew update
          brew install gcc gfortran fftw wget make

          # Use Homebrew gcc/gfortran, but **only bare names**, no full paths.
          # QE docs explicitly warn that passing full paths to compilers
          # can lead to obscure build errors.
          BREW_GCC_VERSION=$(brew list --versions gcc | awk '{print $2}' | cut -d. -f1 || true)

          if [ -n "$BREW_GCC_VERSION" ]; then
            echo "Using Homebrew gcc-$BREW_GCC_VERSION / gfortran-$BREW_GCC_VERSION"
            echo "CC=gcc-$BREW_GCC_VERSION" >> "$GITHUB_ENV"
            echo "FC=gfortran-$BREW_GCC_VERSION" >> "$GITHUB_ENV"
          else
            echo "Homebrew gcc version not detected, falling back to system compilers"
            echo "CC=cc" >> "$GITHUB_ENV"
            echo "FC=gfortran" >> "$GITHUB_ENV"
          fi

      # ---------- Common: download QE ----------

      - name: Download and unpack QE
        run: |
          mkdir -p "$(dirname "$QE_SRC_DIR")"
          cd "$(dirname "$QE_SRC_DIR")"

          wget -q "$QE_TARBALL_URL" -O qe.tar.gz
          tar -xzf qe.tar.gz
          rm qe.tar.gz

          EXTRACTED=$(find . -maxdepth 1 -type d -name "q-e-qe-7.5*" | head -1)
          if [ -z "$EXTRACTED" ]; then
            echo "Failed to find extracted QE source directory"
            exit 1
          fi

          rm -rf "$QE_SRC_DIR"
          mv "$EXTRACTED" "$QE_SRC_DIR"

          echo "QE source extracted to: $QE_SRC_DIR"
          ls -la "$QE_SRC_DIR" | head -20
          test -f "$QE_SRC_DIR/configure" || (echo "configure script not found!" && exit 1)

      # ---------- Configure ----------

      - name: Configure QE (Linux, OpenBLAS)
        if: matrix.os == 'ubuntu-latest'
        run: |
          cd "$QE_SRC_DIR"
          ./configure \
            F90=gfortran \
            MPIF90=gfortran \
            BLAS_LIBS="-lopenblas" \
            LAPACK_LIBS="-lopenblas"

      - name: Configure QE (macOS, Accelerate)
        if: matrix.os == 'macos-14'
        run: |
          cd "$QE_SRC_DIR"
          ./configure \
            CC="${CC:-cc}" \
            F90="${FC:-gfortran}" \
            MPIF90="${FC:-gfortran}" \
            CPP="${CC:-cc} -E" \
            BLAS_LIBS="-framework Accelerate" \
            LAPACK_LIBS="-framework Accelerate"

      # ---------- Build & package ----------

      - name: Build QE (pw.x only)
        run: |
          cd "$QE_SRC_DIR"
          make pw -j2
          ls -la PW/src/pw.x || (echo "pw.x not built" && exit 1)

      - name: Package build artifacts
        run: |
          mkdir -p "$QE_PREFIX/bin"
          cp "$QE_SRC_DIR"/PW/src/pw.x "$QE_PREFIX/bin/"
          ls -R "$QE_PREFIX"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: qe-${{ env.QE_VERSION }}-${{ matrix.os }}
          path: ${{ env.QE_PREFIX }}
