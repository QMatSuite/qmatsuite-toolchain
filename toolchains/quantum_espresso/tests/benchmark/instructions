$foldername = "win-oneapi_1_serial_internalFFTW"
$foldername = "win-oneapi_2_serial_MKLFFT"
$foldername = "win-oneapi_5_MSMPI_OMP_O2_MKLFFT"
$foldername = "win-oneapi_4_OMP_O2_MKLFFT"
$foldername = "win-oneapi_6_MSMPI_OMP_O2_MKLFFT"
$foldername = "qe6.4.1_win\qe"
$foldername = "qe-7.5-win-oneapi-msmpi\bin"
$foldername = "qe-7.5-win-oneapi-msmpi-libxc\bin"

$env:KMP_SETTINGS = "1"
$env:OMP_DISPLAY_ENV = "TRUE"

cd toolchains\quantum_espresso\tests\benchmark
$distDir = "..\..\windows\oneapi\dist\$foldername"
$env:PATH = "$distDir;$env:PATH"

pw.exe -in si100.in > "si100_$foldername.out" 2>&1

mpiexec.exe -n 4 pw.exe -in si100.in > "si100_$foldername.out" 2>&1
mpiexec.exe -n 4 pw.exe -in si100.in > si100_qe6.4.1_MSMPI.out 2>&1

$env:OMP_NUM_THREADS = "1"
$env:MKL_NUM_THREADS = "8"

# go to pw_libxc to test libxc enabled release

# test release
$distDir = "qmatsuite-toolchain\toolchains\quantum_espresso\windows\oneapi\dist"
cd $distDir
Get-FileHash .\qe-7.5-win-oneapi-msmpi.zip -Algorithm SHA256
Get-FileHash .\qe-7.5-win-oneapi-msmpi-libxc.zip -Algorithm SHA256

gh --version
gh attestation verify .\qe-7.5-win-oneapi-msmpi.zip --repo QMatSuite/qmatsuite-toolchain
gh attestation verify .\qe-7.5-win-oneapi-msmpi-libxc.zip --repo QMatSuite/qmatsuite-toolchain

# check signature
$root = ".\qe-7.5-win-oneapi-msmpi\bin"
$root = ".\qe-7.5-win-oneapi-msmpi-libxc\bin"

$targets = Get-ChildItem -Path $root -Recurse -File -Include *.exe,*.dll
$report = foreach ($f in $targets) {
  $sig = Get-AuthenticodeSignature $f.FullName
  [pscustomobject]@{
    File = $f.FullName
    Status = $sig.Status
    Signer = $sig.SignerCertificate.Subject
    Thumbprint = $sig.SignerCertificate.Thumbprint
    Timestamp = $sig.TimeStamperCertificate.Subject
  }
}

$report | Group-Object Status | Sort-Object Count -Descending | Format-Table -AutoSize
$report | Where-Object Status -ne 'Valid' | Sort-Object File | Format-Table -AutoSize


# Alternative
# choco install sysinternals -y
C:\ProgramData\chocolatey\lib\sysinternals\tools\sigcheck64.exe -c -s $root > sigcheck.csv
C:\ProgramData\chocolatey\lib\sysinternals\tools\sigcheck64.exe -q -m -i -s $root
Import-Csv sigcheck.csv |
  Where-Object { $_.Verified -ne "Signed" } |
  ForEach-Object {
    Write-Error "NOT SIGNED: $($_.Path)"
  }